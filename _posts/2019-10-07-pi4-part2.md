---
layout: post
published: true
title: Raspberry Pi 4 full configuration - part 2
subtitle: Custom DNS with Dnsmasq
tags: [raspberrypi, dnsmasq, IPv4, IPv6]
---

[Go to part 1]({% post_url 2019-10-07-pi4-part1 %})

My Internet provider, StarHub, offers a nice 1 Gbps broadband access with full IPv4 and IPv6 support and a great LinkSys EA EA8100 router. The configuration is really basic but it will fit my needs. The router will keep the DHCP task for IPv4 and the RA for IPv6 and I will only provide a custom DNS.

From my experience, keeping the DHCP and the routing on the router allows me to break everything on the Raspberry Pi while my family continue to enjoy Internet and it avoids screams, headaches and divorce (yes it can escalate quickly ;-) ).

I start by adding a DHCP reservation for the Pi
![I would like to book an address please]({{site.baseurl}}/img/20191007/rpi-dhcp-static_thumb.jpg)

I install `dnsmasq` and configure it to forward DNS queries to CloudFlare and Google DNS

```shell
$ sudo apt install dnsmasq

$ sudo tee /etc/dnsmasq.d/main.conf > /dev/null << EOF
# Listen on this standard DNS port
port=53

# Never forward plain names (without a dot or domain part)
domain-needed

# Never forward addresses in the non-routed address spaces.
bogus-priv

# Don't read /etc/resolv.conf or any other file.
# Use only the configuration provided by this file.
no-resolv

# Don't poll changes from external files (like /etc/resolv.conf)
no-poll

# Upstream DNS servers
server=2606:4700:4700::1001
server=2001:4860:4860::8844
server=1.1.1.1
server=8.8.8.8

# Ensure we use servers in order
strict-order

# Listen to a specific interface only
interface=eth0
bind-interfaces

# Increase the cachesize (the default value is 150)
cache-size=1500

# Don't store in cache the invalid resolutions
no-negcache

# Used to test our configuration later
address=/testdomain.tld/1.2.3.4
EOF

$ sudo systemctl restart dnsmasq
```

Finally, I assign my DNS server as a static DNS on the router
![Use me]({{site.baseurl}}/img/20191007/rpi-dhcp-dns_thumb.jpg)

It's time to check our configuration. On the Pi, I install `radvdump` to retrieve the IPv6 RA messages and the published DNS server

```shell
$ sudo apt install radvdump

$ sudo radvdump
[After few seconds]
#
# radvd configuration generated by radvdump 2.17
# based on Router Advertisement from fe80::3223:3ff:fec1:5796
# received by interface eth0
#

interface eth0
{
        AdvSendAdvert on;
        # Note: {Min,Max}RtrAdvInterval cannot be obtained with radvdump
        AdvManagedFlag off;
        AdvOtherConfigFlag on;
        AdvReachableTime 0;
        AdvRetransTimer 0;
        AdvCurHopLimit 64;
        AdvDefaultLifetime 1800;
        AdvHomeAgentFlag off;
        AdvDefaultPreference medium;
        AdvLinkMTU 1500;
        AdvSourceLLAddress on;

        prefix 2404:e801:XXXX:XXXX::/64
        {
                AdvValidLifetime 172637;
                AdvPreferredLifetime 172637;
                AdvOnLink on;
                AdvAutonomous on;
                AdvRouterAddr off;
        }; # End of prefix definition


        route 2404:e801:XXXX:XXXX::/64
        {
                AdvRoutePreference high;
                AdvRouteLifetime 172800;
        }; # End of route definition


        RDNSS 2404:e801:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX
        {
                AdvRDNSSLifetime 300;
        }; # End of RDNSS definition

}; # End of interface definition
```

The linksys router exposes a DNS server on `2404:e801:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX`. Let's check our test domains can be resolved to confirm we're using our own DNS server

```shell
$ sudo apt install dnsutils

$ dig @192.168.1.1 testdomain.tld A +short
1.2.3.4

$ dig @2404:e801:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX testdomain.tld A +short
1.2.3.4
```

[Go to part 3]({% post_url 2019-10-08-pi4-part3 %})
