---
layout: post
published: true
title: Raspberry Pi 4 full configuration - part 2
subtitle: Custom DNS with Dnsmasq
tags: [raspberrypi, dnsmasq, IPv4, IPv6]
---

My Internet provider, StarHub, offers a nice 1 Gbps broadband access with full IPv4 and IPv6 support and a nice Linksys EA EA8100 router. The available configuration options are basic but it will fit my needs for a home network.

From here, there is two options:

- Keeping the DHCP server on the router and providing only a custom DNS server.
- Providing full DHCP and DNS services from the Raspberry Pi.

Obviously, I tested both ;-) :



## Dnsmasq configuration for IPv4 and IPv6 DNS only

From my experience, keeping the DHCP and the routing on the router allows me to break everything on the Raspberry Pi while my family continue to enjoy Internet and it help to avoid screams, headaches and divorce (yes it can escalate quickly ;-) ). It's the first option I tested.



### Dnsmasq configuration

I start by adding a DHCP reservation for the Pi (`192.168.1.100`)
![I would like to book an address please]({{site.baseurl}}/img/20191007/rpi-dhcp-static_thumb.jpg)

I install `dnsmasq` and configure it to forward DNS queries to CloudFlare and Google DNS.

```console
$ sudo apt install dnsmasq

$ sudo tee /etc/dnsmasq.d/main.conf > /dev/null << "EOF"
# Listen on this standard DNS port
port=53

# Never forward plain names (without a dot or domain part)
domain-needed

# Never forward addresses in the non-routed address spaces.
bogus-priv

# Don't read /etc/hosts file
no-hosts

# Don't read /etc/resolv.conf or any other file.
# Use only the configuration provided by this file.
no-resolv

# Don't poll changes from external files (like /etc/resolv.conf)
no-poll

# Upstream DNS servers
server=2606:4700:4700::1001
server=2001:4860:4860::8844
server=1.1.1.1
server=8.8.8.8

# Ensure we use servers in order
strict-order

# Listen to a specific interface only
interface=eth0
bind-interfaces

# Increase the cachesize (the default value is 150)
cache-size=1500

# Don't store in cache the invalid resolutions
no-negcache

# Used to test our configuration later
address=/testdomain.tld/1.2.3.4
EOF

$ sudo systemctl restart dnsmasq
```

Finally, on the router, I assign my DNS server as a static DNS.
![Use this server please...]({{site.baseurl}}/img/20191007/rpi-dhcp-dns_thumb.jpg)

As you may notice, the DHCP leases and the RA are still exposing the router address (`192.168.1.1` and `2404:e801:XXXX:XXXX:3223:3ff:fec1:5796` in my case). But now, when the DNS query is received by the router, it's forwarded it to our own DNS server.



### Test

Let's check that our test domain is properly resolved to confirm we're using our own DNS server.

```console
$ sudo apt install dnsutils

-- Check the IPv4 DNS server provided by the router
$ dig @192.168.1.1 testdomain.tld A +short
1.2.3.4

-- Check the IPv6 DNS server provided by the router
$ dig @2404:e801:XXXX:XXXX:3223:3ff:fec1:5796 testdomain.tld A +short
1.2.3.4
```



## Dnsmasq configuration for DHCPv4 and stateless IPv6

In some situation, you want to run your own DHCP server for IPv4 and IPv6 to get a total control of your network. For IPv4, it's straight forward but for IPv6, you have to know some differences.

With IPv6, the hosts don't need a DHCP server to retrieve an IP address. The most common configuration mode is called stateless configuration. Basically, a router on the network sends Router Advertisement (RA) packets with network prefixes and routes and each host generates one or several IPv6 addresses based on the prefix. The router can also send the DNS (RDNSS) configuration in the Router Advertisement message.



### Checking IPv6 RA message

I install `radvdump` to retrieve the IPv6 RA messages and the DNS server address published by the router.

```console
$ sudo apt install radvdump

$ sudo radvdump
[After few seconds]
#
# radvd configuration generated by radvdump 2.17
# based on Router Advertisement from fe80::3223:3ff:fec1:5796
# received by interface eth0
#

interface eth0
{
        AdvSendAdvert on;
        # Note: {Min,Max}RtrAdvInterval cannot be obtained with radvdump
        AdvManagedFlag off;
        AdvOtherConfigFlag on;
        AdvReachableTime 0;
        AdvRetransTimer 0;
        AdvCurHopLimit 64;
        AdvDefaultLifetime 1800;
        AdvHomeAgentFlag off;
        AdvDefaultPreference medium;
        AdvLinkMTU 1500;
        AdvSourceLLAddress on;

        prefix 2404:e801:XXXX:XXXX::/64
        {
                AdvValidLifetime 100858;
                AdvPreferredLifetime 100858;
                AdvOnLink on;
                AdvAutonomous on;
                AdvRouterAddr off;
        }; # End of prefix definition


        route 2404:e801:XXXX:XXXX::/64
        {
                AdvRoutePreference high;
                AdvRouteLifetime 172800;
        }; # End of route definition


        RDNSS 2404:e801:XXXX:XXXX:3223:3ff:fec1:5796
        {
                AdvRDNSSLifetime 300;
        }; # End of RDNSS definition

}; # End of interface definition
```



### Static IP configuration

Based on the prefix `2404:e801:XXXX:XXXX` found in the `radvdump` output above, I can assign static IPv4 and IPv6 addresses to the Raspberry Pi and reboot.

```console
sudo nano /etc/dhcpcd.conf
[SNIP]
static ip_address=192.168.1.2/24
static ip6_address=2404:e801:XXXX:XXXX::1:2/64
static routers=192.168.1.1
static domain_name_servers=127.0.0.1
```



### Dnsmasq configuration

On my Linksys router, it's not possible to stop the RA messages but you can notice the flag `AdvOtherConfigFlag` is `on` in the `radvdump` output above. It means the hosts will generate their own IP but will request additional configuration on the network. So we will configure Dnsmasq as a DHCPv6 server to provide additional IP and DNS configuration.

```console
$ sudo apt install dnsmasq

$ sudo tee /etc/dnsmasq.d/main.conf > /dev/null << "EOF"
# Listen on this standard DNS port
port=53

# Never forward plain names (without a dot or domain part)
domain-needed

# Never forward addresses in the non-routed address spaces.
bogus-priv

# Don't read /etc/hosts file
no-hosts

# Don't read /etc/resolv.conf or any other file.
# Use only the configuration provided by this file.
no-resolv

# Don't poll changes from external files (like /etc/resolv.conf)
no-poll

# Upstream DNS servers
server=2606:4700:4700::1001
server=2001:4860:4860::8844
server=1.1.1.1
server=8.8.8.8

# Ensure we use servers in order
strict-order

# Listen to a specific interface only
interface=eth0
bind-interfaces

# Set the domain for dnsmasq
domain=local

# Add local-only domains here, queries in these domains are answered
# from /etc/hosts or DHCP only.
local=/local/

# Automatically add local domain to simple names
expand-hosts

# IPv4 range
dhcp-range=192.168.1.50,192.168.1.150,255.255.255.0,12h

# IPv4 DNS server (our Dnsmasq instance)
dhcp-option=option:dns-server,192.168.1.2

# IPv4 gateway (our router)
dhcp-option=option:router,192.168.1.1

# IPv6 range. The prefix is retrieved from eth0 interface
# Ask the client to keep slaac address and to use DHCP-provided address.
# With ra-names, Dnsmasq tries to use the IPv4 lease to derive a valid IPv6 address and store associated name in the DNS
dhcp-range=::1:ff,::1:ffff,constructor:eth0,ra-names,slaac,12h

# IPv6 DNS server (our Dnsmasq instance)
dhcp-option=option6:dns-server,[2404:e801:XXXX:XXXX::1:2]

# Ask client to poll for option changes every six hours
dhcp-option=option6:information-refresh-time,15m

# Mark our RA with high priority and specify 0 for router lifetime
# to specify Dnsmasq address should not be used as a valid route
ra-param=eth0,high,0,0

# Don't fill the logs with RA related messages
quiet-ra

# Set the DHCP server to authoritative mode to speed up leases acquisition.
dhcp-authoritative

# Enable DHCPv4 Rapid Commit
dhcp-rapid-commit

# Increase the cachesize (the default value is 150)
cache-size=1500

# Don't store in cache the invalid resolutions
no-negcache

# Used to test our configuration later
address=/testdomain.tld/1.2.3.4
EOF

$ sudo systemctl restart dnsmasq
```

As soon as Dnsmasq is restarted, I deactivate the DHCP server on the router.



### Test

I renew my lease on a client machine and check that the IPv4 and IPv6 configurations are properly applied. I also ensure my fake domain [testdomain.tld] is properly resolved by the DNS servers published by RA and used for IPV6. 
Depending of your OS and the IPv6 stack implementation, you can notice 2 IPv6 servers registered on your client machine. It can happen because the router and the raspberry pi are both sending RA messages but according the [RFC 6106](https://tools.ietf.org/html/rfc6106#section-5.3.1), the DNS information from DHCP should take precedence over the RA.



## Bonus - Additional hosts file

It's always useful to have a nice name resolution for the local hosts. It's handled automatically by Dnsmasq for the hosts registered through DHCP but not for the hosts with static IP.
I just have to add a custom hosts file to customize the resolution.
```console
$ sudo tee -a /etc/dnsmasq.d/main.conf > /dev/null << "EOF"
addn-hosts=/etc/dnsmasq-hosts
EOF

$ sudo tee /etc/dnsmasq-hosts > /dev/null << "EOF"
# Raspberry Pi
192.168.1.2 pisin
2404:e801:XXXX:XXXX::1:2 pisin

# Router
192.168.1.1 router
EOF

$ sudo systemctl restart dnsmasq
```

[Part 1 - Initial configuration]({% post_url 2019-10-07-pi4-part1 %})

[Part 3 - Docker and docker-compose installation]({% post_url 2019-10-08-pi4-part3 %})
