---
layout: post
published: true
title: Raspberry Pi 4 full configuration - part 4
subtitle: Pi-Hole in a Docker container
tags: [raspberrypi, docker, pi-hole, dnsmasq]
---

[Pi-Hole](https://pi-hole.net/) is a custom DNS server mainly used to block advertisements. Once installed, it acts as the standard DNS server for my whole network and I don't need to configure any adblock plugin on my devices.

Pi-Hole will be the default DNS server on my network but I will not use its DHCP capabilities. I will keep my original Dnsmasq instance for DHCP and as an upstream server for DNS resolution. This way, it's easier to revert to a configuration without Pi-Hole with only limited changes.

![J'ai pisin]({{site.baseurl}}/img/20191013/pi-hole_thumb.jpg)

### Pi-Hole configuration

I start by creating a docker-compose.yml file with all the required options

```console
$ export PASSWORD=password
$ export HOST_IP4=192.168.1.2
$ export HOST_IP6=2404:e801:xxxx:xxxx::1681:2

$ mkdir /opt/docker/pihole && cd /opt/docker/pihole
$ tee /opt/docker/pihole/docker-compose.yml > /dev/null << EOF
version: "3"

services:
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    ports:
      - '53:53/tcp'
      - '53:53/udp'
      - '80:80/tcp'
    environment:
      TZ: 'Asia/Singapore'
      WEBPASSWORD: '${PASSWORD}'
      DNS1: '172.17.0.1#5353'
      DNS2: 'no'
      ServerIP: '${HOST_IP4}'
      ServerIPv6: '${HOST_IP6}'
    volumes:
      - './config/pihole/:/etc/pihole/'
      - './config/dnsmasq.d/:/etc/dnsmasq.d/'
    dns:
      - 127.0.0.1 # Required for local names resolution
      - 1.1.1.1 # Required during startup when Pi-Hole is not fully started
    network_mode: "host"
    restart: unless-stopped
EOF
```

Then I modify the Pi-Hole's Dnsmasq configuration to force it to listen on all Docker interfaces and not only on eth0

```console
$ mkdir -p /opt/docker/pihole/config/dnsmasq.d/
$ tee /opt/docker/pihole/config/dnsmasq.d/10-docker.conf > /dev/null << "EOF"
interface=docker0
interface=br-*
EOF
```

Finally, I update the Dnsmasq's host configuration to listen on port 5353 instead 53. If at any point, I need to remove Pi-Hole, the only setting to revert is this `port` option.

```console
$ sudo sed -i -e 's/^port=53$/^port=5353$/g' /etc/dnsmasq.d/main.conf
```

I restart dnsmasq and starts the Pi-Hole container

```console
$ sudo systemctl restart dnsmasq
$ docker-compose -f /opt/docker/pihole/docker-compose.yml up -d

-- I review the logs to ensure Pi-Hole is starting properly
$ docker-compose -f /opt/docker/pihole/docker-compose.yml logs -f
```

Once started, I can access the Pi-Hole administration on `http://192.168.1.2/admin/`

[Part 3 - Docker with IPv6 and Docker Compose]({% post_url 2019-10-08-pi4-part3 %})

[Part 5 - VPN and Torrents container]